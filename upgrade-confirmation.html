<!DOCTYPE html>
<html>
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17588707745"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'AW-17588707745');
</script>

  <!-- Event snippet for Paid user conversion page -->
<script>
 // Extract parameters from URL
const urlParams = new URLSearchParams(window.location.search);
const amount = parseFloat(urlParams.get('amount')) || 59.0;
const sessionId = urlParams.get('session_id') || '';
const gclid = urlParams.get('gclid');

// Fire conversion with actual values
gtag('event', 'conversion', {
    'send_to': 'AW-17588707745/7IXYCLvJoZ8bEKHD-cJB',
    'value': amount,
    'currency': 'EUR',
    'transaction_id': sessionId,
    'gclid': gclid || undefined
});
</script>

    <link rel="icon" href="https://i.ibb.co/jPjX9SSp/Screen-Shot-2025-03-28-at-8-16-15-PM.png">
    <title>Payment Successful - LinkFinder AI</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f9fafb;
        }
        .container {
            max-width: 480px;
            text-align: center;
            padding: 40px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #2563eb;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h1 {
            color: #111827;
            font-size: 24px;
            margin-bottom: 20px;
        }
        #status {
            color: #4b5563;
            font-size: 16px;
            line-height: 1.5;
        }
        .success-icon {
            color: #2563eb;
            font-size: 48px;
            margin-bottom: 20px;
        }
        .error-message {
            color: #ef4444;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 20px;
            color: #111827;
            text-decoration: none;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: #2563eb;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }
    </style>
  <!-- Privacy-friendly analytics by Plausible -->
  <script async src="https://plausible.io/js/pa-LTP3nlbjr9NybMEgzpwxU.js"></script>
  <script>
    window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
    plausible.init()
  </script>
</head>
<body>
    <div class="container">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-search"></i>
            </div>
            <span class="logo-text">LinkFinder AI</span>
        </div>
        <div class="success-icon">‚úì</div>
        <h1>Payment Successful!</h1>
        <div id="spinner" class="spinner"></div>
        <div id="status">Confirming payment...</div>
        <div id="error-container"></div>
    </div>

    <script>
        // ULTRA-RELIABLE payment confirmation for LinkFinder AI
        (async function() {
            const statusElement = document.getElementById('status');
            const spinnerElement = document.getElementById('spinner');
            const errorContainer = document.getElementById('error-container');
            
            // Logging function (console only - no UI debug)
            function log(message, data = null) {
                const timestamp = new Date().toISOString();
                const logEntry = `[${timestamp}] LinkFinder AI - ${message}`;
                console.log(logEntry, data || '');
            }

            // Ultra-reliable fetch with multiple fallback strategies
            async function ultraReliableFetch(url, options, maxRetries = 5) {
                const methods = [
                    // Method 1: Standard fetch
                    () => fetch(url, options),
                    
                    // Method 2: XMLHttpRequest fallback
                    () => new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', url, true);
                        xhr.setRequestHeader('Content-Type', 'application/json');
                        xhr.setRequestHeader('Accept', 'application/json');
                        
                        xhr.onload = function() {
                            resolve({
                                ok: xhr.status >= 200 && xhr.status < 300,
                                status: xhr.status,
                                statusText: xhr.statusText,
                                json: () => Promise.resolve(JSON.parse(xhr.responseText)),
                                text: () => Promise.resolve(xhr.responseText)
                            });
                        };
                        
                        xhr.onerror = () => reject(new Error('XMLHttpRequest failed'));
                        xhr.ontimeout = () => reject(new Error('XMLHttpRequest timeout'));
                        xhr.timeout = 60000; // 60 second timeout
                        
                        xhr.send(options.body);
                    }),
                    
                    // Method 3: Direct worker bypass (fallback to server)
                    () => fetch('https://eliasse-n8n.onrender.com/webhook/linkfinder-upgrade', options)
                ];

                for (let methodIndex = 0; methodIndex < methods.length; methodIndex++) {
                    for (let attempt = 1; attempt <= maxRetries; attempt++) {
                        try {
                            log(`Attempt ${attempt}/${maxRetries} using method ${methodIndex + 1}`);
                            
                            const response = await Promise.race([
                                methods[methodIndex](),
                                new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('Request timeout')), 60000)
                                )
                            ]);
                            
                            log(`Method ${methodIndex + 1} attempt ${attempt} succeeded`, {
                                status: response.status,
                                ok: response.ok
                            });
                            
                            return response;
                            
                        } catch (error) {
                            log(`Method ${methodIndex + 1} attempt ${attempt} failed`, {
                                error: error.message,
                                stack: error.stack
                            });
                            
                            if (attempt < maxRetries) {
                                const delay = Math.min(1000 * Math.pow(2, attempt), 10000);
                                log(`Waiting ${delay}ms before retry...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                            }
                        }
                    }
                }
                
                throw new Error('All methods and retries exhausted');
            }

            try {
                log('=== PAYMENT CONFIRMATION STARTED ===');
                log('Page URL', window.location.href);
                
                // Get URL parameters with comprehensive fallback
                const urlParams = new URLSearchParams(window.location.search);
                const urlHash = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : null;
                
                log('URL search params', Object.fromEntries(urlParams));
                if (urlHash) log('URL hash params', Object.fromEntries(urlHash));
                
                // Get session ID with all possible parameter names
                let sessionId = urlParams.get('session_id') || 
                               urlParams.get('checkout_session_id') || 
                               urlParams.get('id') ||
                               urlParams.get('sessionId') ||
                               urlParams.get('checkoutSessionId');
                
                if (!sessionId && urlHash) {
                    sessionId = urlHash.get('session_id') || 
                               urlHash.get('checkout_session_id') || 
                               urlHash.get('id') ||
                               urlHash.get('sessionId') ||
                               urlHash.get('checkoutSessionId');
                }
                
                // Check localStorage/sessionStorage
                if (!sessionId) {
                    const storageKeys = ['checkout_session_id', 'session_id', 'linkfinder_session_id'];
                    for (const key of storageKeys) {
                        sessionId = localStorage.getItem(key) || sessionStorage.getItem(key);
                        if (sessionId) {
                            log(`Found session ID in storage`, { key, sessionId });
                            break;
                        }
                    }
                }
                
                // Get user token
                let userToken = urlParams.get('token') || 
                               urlParams.get('customer_id') || 
                               urlParams.get('user_id') ||
                               urlParams.get('userToken');
                
                if (!userToken && urlHash) {
                    userToken = urlHash.get('token') || 
                               urlHash.get('customer_id') || 
                               urlHash.get('user_id') ||
                               urlHash.get('userToken');
                }
                
                if (!userToken) {
                    const tokenKeys = ['linkFinderToken', 'linkfinder_user_token', 'userToken', 'customer_id', 'user_id'];
                    for (const key of tokenKeys) {
                        userToken = localStorage.getItem(key) || sessionStorage.getItem(key);
                        if (userToken) {
                            log(`Found user token in storage`, { key, hasToken: !!userToken });
                            break;
                        }
                    }
                }
                
                log('Extracted data', {
                    sessionId: sessionId ? sessionId.substring(0, 15) + '...' : 'MISSING',
                    userToken: userToken ? 'PRESENT' : 'MISSING',
                    fullSessionId: sessionId // For debugging
                });
                
                // Validate required data
                if (!sessionId) {
                    throw new Error('‚ùå CRITICAL: No session ID found in URL or storage');
                }
                
                // Prepare request data
                const requestData = {
                    checkout_session_id: sessionId,
                    user_token: userToken,
                    lookup_session: true,
                    timestamp: new Date().toISOString(),
                    source: 'linkfinder_payment_page',
                    page_url: window.location.href,
                    user_agent: navigator.userAgent,
                    service: 'linkfinder-ai'
                };
                
                log('Request data prepared', requestData);
                
                // Update UI
                statusElement.textContent = 'Confirming payment...';
                
                // Make the ultra-reliable API call
                log('üöÄ Starting API call to LinkFinder AI upgrade worker...');
                
                const response = await ultraReliableFetch(
                    'https://linkfinderaiupgrade.hamoureliasse.workers.dev/', 
                    {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'User-Agent': 'LinkFinderAI-PaymentConfirmation/1.0'
                        },
                        body: JSON.stringify(requestData)
                    }
                );
                
                log('‚úÖ API call completed', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    throw new Error(`Server responded with ${response.status}: ${errorText}`);
                }
                
                let responseData;
                try {
                    responseData = await response.json();
                    log('‚úÖ Response data parsed', responseData);
                } catch (jsonError) {
                    log('‚ö†Ô∏è Failed to parse JSON response, getting text');
                    responseData = { message: await response.text() };
                }
                
                // Success!
                log('üéâ LINKFINDER AI PAYMENT CONFIRMATION SUCCESSFUL');
                
                spinnerElement.style.display = 'none';
                statusElement.innerHTML = 'Payment confirmed!<br>Redirecting to LinkFinder AI...';
                
                // Clean up storage
                const keysToClean = ['linkFinderToken', 'linkfinder_user_token', 'userToken', 'customer_id', 'user_id', 'checkout_session_id', 'session_id', 'linkfinder_session_id'];
                keysToClean.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                log('üßπ Storage cleaned up');
                
                // Wait and redirect to LinkFinder AI app
                await new Promise(resolve => setTimeout(resolve, 2000));
                log('üîÑ Redirecting to LinkFinder AI app...');
                
                // Redirect with token if available
                const redirectUrl = userToken ? 
                    `https://linkfinderai.com/app?token=${userToken}` : 
                    'https://linkfinderai.com/app';
                
                window.location.href = redirectUrl;
                
            } catch (error) {
                log('‚ùå FATAL ERROR', {
                    message: error.message,
                    stack: error.stack
                });
                
                spinnerElement.style.display = 'none';
                statusElement.innerHTML = 'Unable to confirm payment automatically';
                
                errorContainer.innerHTML = `
                    <div class="error-message">
                        <strong>Payment Processing Issue</strong><br><br>
                        Your payment was successful, but we're having trouble confirming it automatically.
                        <br><br>
                        Please contact our support team and we'll activate your account manually:
                        <br><br>
                        <strong>üìß support@unlimited-leads.online</strong>
                        <br><br>
                        Please include your payment confirmation details when contacting support.
                    </div>
                `;
                
                // Do NOT redirect on error - let user contact support
            }
        })();
    </script>
</body>
</html>
